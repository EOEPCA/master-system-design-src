
= User Management

In the context of the Common Architecture, User Management covers the following main functional areas:

Identity and Access Management (IAM)::
Identification/authentication of users and authorization of access to protected resources (data/services) within the EP.

Accounting and Billing::
Maintaining an accounting record of all user accesses to data/services/applications, supported by appropriate systems of credits and billing.

User Profile::
Maintenance of details associated to the user that may be needed in support of access management and billing.

These are explored in the following sub-sections.

== Identity and Access Management (IAM)

The goal of IAM is to uniquely identify the user and limit access to protected resources to those having suitable access rights. We assume an Attribute Based Access Control (ABAC) approach in which authorisation decisions are made based upon attributes required by resources and possessed (as claims) by users. ABAC is is seen as a more flexible approach than Role Base Access Control (RBAC), affording the ability to express more sofisticated authorisations rules beyond the role(s) of the user - and noting the fact that a role-based ruleset could be implemented within an attribute based approach, (i.e. RBAC is a subset/specialisation of ABAC).

In achieving this there are three main concerns:

* Unique user identification
* Determine what attributes are required to access the protected resource
* Determine whether the user has the required attributes

For the Common Architecture, we establish separation of User Identification from Access Management. User identity is federated and handled external to the platform. Within the Network of EO Resources, resources held within an exploitation platform are made available to federated partner platforms, under the policy decision of the local platform:

* The identity is provided externally. The external IdP has no association to the exploitation platform, and hence is not the appropriate place to administer attributes that relate to EP resources.
* The protected resources are under the custodianship of the exploitation platform and hence the exploitation platform defines internally its rules for accessing its protected resources.
* The administrative domain for a set of attributes should not be tied to an exploitation platform, which facilitates the provision of federation and virtual organisations.

=== IAM Approach

<<img_iamOverview>> presents the basic approach. At this stage it does not consider the case in which an exploitation platform accesses resources in another platform on behalf of a user, (for example a workflow step that is invoked on another platform). This is addressed in a later section. Users are authenticated by redirection to an external identity provider, (their ‘home’ IdP). This returns the authentication decision and some basic user information as required (such as name, email, etc.).

[#img_iamOverview,reftext='{figure-caption} {counter:figure-num}']
.Identity and Access Management Overview
image::iam-overview.png[width=1000,align="center"]

Each protected resource is fronted by its Policy Enforcement Point (PEP) that will only permit access if the appropriate conditions are met. This decision is made according to a set of rules that are under the control of and configured within the exploitation platform.

The Authentication Service is provided as a common component that is utilised by each PEP to perform the authentication flow with the external IdPs. In the case of an unauthenticated request, the PEP will initiate the Authentication Service by redirection of the User’s originating request. The successful flow ultimately redirects back to the PEP and so maintains the direct connection between the end-user agent and the resource server. This direct connection is of particular importance in the case of significant data volumes being returned to the User. An alternative approach would be the use of an API Gateway to perform the role of the PEP, acting as an intermediary between the end-user agent and the resource server. However, this would have the effect of proxying the connection and thus spoiling the direct communication between end-user agent and resource server, and so introduce an inefficiency in the data path.

The PEP interrogates the PDP for an authorisation decision. The PEP sends a request that indicates the pertinent details of the attempted access, including:

* Identity of end-user (XACML subject)
* The API (path/version etc.) being accessed (XACML resource)
* The operation (HTTP verb) being performed (XACML action)

The rules are expressed through attributes, and it is the job of the Policy Decision Point (PDP) to determine, for a given request, what attributes are required and what attributes the user possesses, in order to provide its access decision. In order to know whether a user possesses a given attribute it is necessary to interrogate the appropriate Attribute Authority for the attribute.

It should be additionally noted that the decision to allow the user access depends upon dynamic 'attributes', such as whether the user has enough credits to 'pay' for their usage, or whether they have accepted the necessary Terms & Conditions for a given dataset or service. Thus, the PDP must interrogate other EP-services such as 'Accounting & Billing' and 'User Profile' to answer such questions.

An Attribute Authority represents the administrative domain for a set of attributes - and acts as Policy Information Point (PIP) for the attributes under its governance. A given attribute is administered by a single Attribute Authority. Thus, when making its decision, the PDP must know for each attribute who is the responsible Attribute Authority (e.g. by lookup), and then interrogate that Attribute Authority to know whether the user possesses the given attribute. For any given attribute, the attribute authority can be one within the EP or administered externally.

Federated access and Virtual Organisations can be effected by use of ‘Federated Attributes’ (see below) that allow common attributes to be delegated under the administrative domain of a nominated Attribute Authority. Thus, for a given attribute there is a single authoritative endpoint for associated attribute queries. The exploitation platform supports the federation/VO by using the federated-attributes in its rules, and defers to the appropriate attribute authority when making policy decisions.

From the perspective of a given EP, two classes of attribute result from the above:

Local Attributes::
Attributes that are used only internally by the EP, in which case the attributes are mapped to the local Attribute Authority.

Federated Attributes::
Attributes that are used to facilitate federated access to resources and in the establishment of Virtual Organisations. In this case the EP maps the attributes to the appropriate Attribute Authority – noting the fact that it could be the local EP if it happens to be the administrative domain for the attribute.

<<img_iamOverviewFlow>> provides an overview of the IAM Flow.

[#img_iamOverviewFlow,reftext='{figure-caption} {counter:figure-num}']
.IAM Overview Flow
image::iam-overview-flow.png[width=1000,align="center"]

Note that the interface between the Authentication Service and the External IdPs is simplified in this view. It is expanded in later sections.

=== IAM Top-level Interfaces

<<img_iamInterfaces>> illustrates the interfaces of the IAM architecture.

[#img_iamInterfaces,reftext='{figure-caption} {counter:figure-num}']
.IAM Interfaces
image::iam-interfaces.png[width=1000,align="center"]

User -> Protected Resource::
The Protected Resource exposes a public API for user consumption.

Protected Resource -> PEP::
The PEP is implemented either as an in-process component of the Protected Resource, or as an out-of-process shim. Either way, the PEP intercepts the incoming request in order to enforce the authorisation policy decision.

PEP -> Authentication Service::
The PEP uses a redirect to delegate the authentication flow to the Authentication Service.

Authentication Service -> External IdP::
In order to support multiple external identity suppliers, the Authentication Service must act as a client to multiple external IdPs, and so must establish individual trust relationships with each of these. Alternatively, the Authentication Service can instead interface to a single external IdP Proxy, that interfaces to the external IdPs on behalf of the EP. The IdP Proxy can provide this service to multiple EPs.

PEP -> AuthZ Rules Engine (PDP)::
Possible use of XACML requests for this interface.

PDP -> Attribute Authority::
Possible use of SAML attribute queries for this interface.

=== Authenticated Identity

==== Authentication Service

The Authentication Services comprises two components:

Authentication Agent::
Provides re-usable login and session management functions within the EP. Designed to provide a simple interface to be exploited by the PEPs. Defers to the Authentication Provider for the user authentication.

Authentication Provider::
Provides the ‘Login-With’ service that allows the platform to support multiple external identity providers.

The Authentication Agent is an OIDC Client to the Authentication Provider (which is an OIDC Provider). The Authentication Agent uses the Authorisation Code Grant Flow to request an Access Token with at least 'oidc' scope. This access token can then be used by the Authentication Agent to access the protected /userinfo endpoint of the Authentication Provider to obtain an ID Token for the authenticated user. The successful retrieval of the ID Token completes the authenticated login of the user, and provides to the Authentication Agent identity information regarding the user, allowing them to be uniquely identified in the platform.

These components are described in the following subsections.

===== Authentication Agent

The Authentication Agent acts as a helper to the PEPs for the purposes of ensuring that the user is authenticated and well identified.

The identity of the authenticated user is maintained in an OIDC ID Token that is represented as a JWT (signed/encrypted by the Authentication Provider) stored as a Cookie in the users browser.

The ID Token is obtained by the Authentication Agent from the Authentication Provider, which is an OIDC Provider. Thus, the Authentication Agent acts as an OIDC Client, using an Authorization Code Flow to obtain the OIDC ID Token.

The returned OIDC ID Token has been signed (JWS) and encrypted (JWE) by the Authentication Provider and thus results in a token that is suitable as a session cookie that asserts authenticated identity with integrity, non-repudiation and confidentiality.

For the interface with the PEP, the Authentication Agent presents the following HTTP endpoints:

/login::
Designed to be called by HTTP-redirect to initiate user login sequence.
Supports redirection back to an originating URL (‘redirect_url’).

/logout::
Designed to be called by HTTP-redirect to initiate user logout.

/validate::
Designed to be called directly to validate the provided signed/encrypted ID Token.
Returns a status indication as to the validity of the token, and the decrypted form of the valid token. This provides user information to the resource server.

Thus, the PEP can extract the ID Token from the HTTP headers, and behave accordingly:

* If the token is not present then no user is logged in, so the request should be redirected to the /login endpoint (HTTP redirect)
* If the token is present, then it should be validated via the /validate endpoint (direct call)
* If the token is valid, then the request can continue (pending authorisation), with the user identity provided in the token
* If the token is invalid, then the request should be redirected to the /login endpoint (HTTP redirect)

For the interface with the Authentication Provider, the Authentication Agent presents the endpoints required to support the OIDC Authorisation Code Flow, including:

/callback::
Callback endpoint to receive the authorisation code grant returned from the Authentication Provider via redirect. This is supplied to the Authentication Provider in the authorisation request (‘redirect_url’), and is registered at Client Registration.

/.well-known/openid-federation::
OIDC Federation API endpoint through which an Exploitation Platform is able to publish Entity Statements about itself. See section ‘OIDC Federation’.

The Authorisation Code Flow would be invoked with a response_type of ‘code’ and scope ‘oidc profile’. Other scopes, such as ‘email’ may also be considered (TBD).

===== Authentication Provider

The Authentication Provider provides a ‘Login With’ service that allows the end-user to select their Identity Provider for purposes of authentication.

It presents as an OIDC Provider to the Exploitation Platform (either internally or externally), specifically supporting the Authorisation Code Flow for the benefit of the Authentication Agent in the platform.

The Authentication Provider is designed to support the onward forwarding of the authentication request through external identify services, which should be expected to include:
* EduGain
* GitHub
* Google
* Twitter
* Facebook
* LinkedIn
* Others TBD

The Authentication Provider must establish itself as a client of all supported external IdPs, with appropriate trust relationships and support for their authentication flows.

The primary endpoints required to support the Authorisation Code Flow are as follows (these endpoints are taken, by example, from OKTA OIDC discovery metadata, https://micah.okta.com/oauth2/aus2yrcz7aMrmDAKZ1t7/.well-known/openid-configuration):

authorization_endpoint (/authorize)::
To initiate the authentication, and to return the code grant.

token_endpoint (/token)::
To exchange the code grant for the access tokens.

userinfo_endpoint (/userinfo)::
To obtain the user information ID token in accordance with the scopes requested in the authorisation request.

jwks_uri (/keys)::
To obtain signing keys for Token validation purposes.

end_session_endpoint (/logout)::
To logout the user from the Authentication Provider, i.e. clear session cookies etc. Although, given that the actual IdP is externalised from the Authentication Provider, it would remain the case that any session cookies maintained by the external IdP would still be in place for a future authentication flow.

introspection_endpoint (/introspect)::
Used by clients to verify access tokens.

revocation_endpoint (/revoke)::
Used for (refresh) token revocation.

As described in section ‘Discovery’, the following endpoints relate to Discovery:

OIDC Discovery (/.well-known/openid-configuration)::
Dynamic discovery of OIDC endpoints by clients.

As described in section ‘Client Registration’, the following endpoints relate to Dynamic Client Registration:

registration_endpoint (/clients)::
Dynamic registration of clients (Authentication Agents).

As described in section ‘OIDC Federation’, the following endpoints relate to the establishment of a federation of collaborating Exploitation Platforms through a dynamic trust model:

/.well-known/openid-federation::
OIDC Federation API endpoint through which Entity Statements are published about itself and other entities (such as Exploitation Platform Authentication Agents). See section ‘Federation’.

==== User Access Flow (Browser)

<<img_iamAuthenticationFlow>> illustrates the basic user access flow, invoked through a user's browser.

[#img_iamAuthenticationFlow,reftext='{figure-caption} {counter:figure-num}']
.IAM Authentication Flow (Browser)
image::iam-authentication-flow.png[width=1000,align="center"]

The session is checked to validate the ID Token that represents the session cookie. If not present or invalid then the login flow through the Authentication Provider and external IdPs is followed.

==== Federated User Access

OIDC provides capabilities that facilitate user access federation, as described in section TBDzzz.

WARNING: The approach described here is almost certainly a bad idea and/or does not make proper (intended) usage of OIDC tokens. Assuming it can be made to work technically, we should consider whether an EP should be allowed to make accesses on another EP on behalf of a user with this 'implied' consent, i.e. does it represent 'leakage' of consent between the platforms in a way that would not be desired by all users ?

In particular, the ability to establish a distributed key-hierarchy with verifiable trust chains, allows the use of ID Token as trusted access identifiers with verifiable signature/encryption, amongst the participants of the EP federation.

This allows…

In this case the signed/encrypted ID Token is used as a Bearer token to request access to protected resources within another EP. The signed/encrypted ID Token can be verified and trusted by the target EP (via ‘jwks_uri’ OIDC endpoints), which can use the token to reliably identify the user.

This could be seen as analogous to the OAuth Client Credentials Flow, in which the user is deemed to have a-priori authorised the third-party access. In this case, it is the identity of the user that is established (third-party), with the authorisation decision subject to the rules of the PDP/PEP of the remote system. The identified user must have appropriate a-priori permissions (attributes) on the target resources to be granted access, (ref. ‘Federated Attributes’).

Thus, it is the ID of the user that has been passed machine-to-machine to facilitate the service federation. This effectively achieves cross-EP single sign-on, without relying upon the user agent of the end-user providing cookies to the other EP.

==== Federated Access Flow (EP<->EP)

TBD

=== Additional OIDC Capabilities

==== OIDC Federation

Reference: https://openid.net/specs/openid-connect-federation-1_0.html

OIDC provides a framework in which RPs and OPs can dynamically establish verifiable trust chains, and so share keys to support signing and encryption of JWTs.

Dedicated ‘federation’ endpoints are defined that allow an entity (such as RP or OP) to publish their own Entity Statements, and to obtain Statements for other entities that are issued by trusted third-parties within the federation. The metadata/signatures within the Entity Statements establish a chain of trust that can be followed to known (trusted) Trust Anchors, and so the Entity Statements and the included entity public keys can be trusted.

Thus, through this mechanism public keys can be shared to underpin the signing and encryption of JWTs.

JWTs signed/encrypted within the context of the federation can be used to achieve federated access between collaborating Exploitation Platforms, including:

Client Registration::
Either implicit or explicit registration of ‘trusted-only’ clients, using the facilities of the Federation API to establish the RP (client) as a trusted entity.

Session Management::
Use of ID Tokens as cross-platform trusted identifiers that can support ‘Federated Access’ flows.

==== OIDC Discovery

Reference: https://openid.net/specs/openid-connect-discovery-1_0.html

OpenID Connect makes provision for two types of discovery:

.	Discovery of the OpenID Provider Issuer based upon the user’s identifier
.	Discovery of the OpenID Provider Configuration Information

In the case of our usage, type 1) is not application since the user’s ID comes from their ‘Home’ organisation and is not (necessarily) tied to an OpenID Connect Provider. Instead the Authentication Provider must implement a discovery ‘flow’ in which the user is able to select the provider of their identity, as one that is supported by the Authentication Provider deployment.

Regarding discovery type 2), the Authentication Provider exposes an OIDC Provider interface, and this should support retrieval of OIDC Provider Configuration Information. Thus, the Authentication Agent can utilise the discovery interface of the Authentication Provider to exploit its services. This is not mandatory – in the simple case the local Authentication Agent can be configured directly with the endpoints URLs of the Authentication Provider.

==== Client Registration

The possibility exists for the Authentication Agent (Relying Party) to perform auto-registration with the Authentication Provider, using OIDC Client Registration. In doing so the client Authentication Agent obtains its Client ID and Secret.

This would be of particular interest in the case that a 'centralised' Authentication Provider is deployed outside of the context of a given Exploitation Platform, as a shared resource acting in the role of an IdP Proxy for many EPs. In this case, the local Authentication provider of each EP would act as OIDC client to this proxy, and it may be convenient for these local providers to use auto-registration. It is to be analysed further when this is desirable within the context of the Exploitation Platform architecture.

The alternative would be to manually configure the local Authentication Provider as a Client of the IdP Proxy. This offers a more tightly managed approach with a possible additional maintenance overhead.

=== Authorization (Policy Decision)

TBD

==== Policy Decision Point (PDP)

TBD

==== Attribute Authority

TBD

== Accounting and Billing

TBD

== User Profile

The User Profile is a system resource that maintains a set of data for each user including:

* User details
* Terms and conditions accepted by the user
* License keys held by the user
* User API key management

The User Profile for a given user is tied to the unique identifier provided by their Home-IdP through the authentication process.
